<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Games - FS Fashion Marketplace</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="game-dark-page">

    <header class="header">
        <div class="header-container">
            <div class="logo">
                <a href="index.html" class="logo-link">
                    <span class="logo-text">FS</span>
                </a>
            </div>
            <nav class="navigation">
                <ul class="nav-links">
                    <li><a href="categoryPage.html">Shop</a></li>
                    <li><a href="brandsPage.html">Brands</a></li>
                    <li><a href="searchPage.html">Search</a></li>
                    <li><a href="inspirationPage.html">Inspiration</a></li>
                    <li><a href="games.html">Games</a></li>
                </ul>
            </nav>
            <div class="right-actions">
                <a href="bagPage.html" class="bag-link">Bag <span id="cart-count"></span></a>
                <div class="utility-links" id="header-utility-links">
                    <a href="accountPage.html">Account</a>
                </div>
            </div>
        </div>
    </header>

    <main class="game-page-container">
        <h1>Voucher Games</h1>
        <p class="game-voucher-count" id="game-voucher-count">Loading vouchers...</p>
        
        <div class="game-wrapper">
            <canvas id="game-canvas"></canvas>
        </div>
    </main>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-column">
                <h3>Brands</h3>
                <ul>
                    <li><a href="brandPage.html?brand=Rick%20Owens">Rick Owens</a></li>
                    <li><a href="brandPage.html?brand=Maison%20Margiela">Maison Margiela</a></li>
                    <li><a href="brandPage.html?brand=Balenciaga">Balenciaga</a></li>
                    <li><a href="brandPage.html?brand=Vivienne%20Westwood">Vivienne Westwood</a></li>
                    <li><a href="brandsPage.html">Other Brands</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Category</h3>
                <ul>
                    <li><a href="categoryPage.html?category=tops">Tops</a></li>
                    <li><a href="categoryPage.html?category=outerwear">Outerwear</a></li>
                    <li><a href="categoryPage.html?category=bottoms">Bottoms</a></li>
                    <li><a href="categoryPage.html?category=accessories">Accessories</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        
        const usersStorageKey = 'fs_users';
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        let currentUserData = null; 
        const voucherCountEl = document.getElementById('game-voucher-count');

        
        if (!loggedInUser) {
            alert('Please sign in to play the Voucher Games.');
            window.location.href = 'accountPage.html';
            return; 
        }
        
        
        function getCurrentUserData() {
            const allUsers = JSON.parse(localStorage.getItem(usersStorageKey)) || [];
            
            return allUsers.find(u => u.email === loggedInUser.email);
        }

        function updateCurrentUserData(updatedUser) {
            let allUsers = JSON.parse(localStorage.getItem(usersStorageKey)) || [];
            const userIndex = allUsers.findIndex(u => u.email === loggedInUser.email);
            if (userIndex !== -1) {
                
                allUsers[userIndex] = updatedUser;
                
                localStorage.setItem(usersStorageKey, JSON.stringify(allUsers));
            }
        }

        
        function calculateDiscountVoucher(difficultyName) {
            const roll = Math.random();
            switch (difficultyName) {
                case 'Easy':
                    if (roll < 0.70) return 5;  
                    if (roll < 0.95) return 10; 
                    return 15; 
                case 'Medium':
                    if (roll < 0.20) return 5;  
                    if (roll < 0.70) return 10; 
                    return 15; 
                case 'Hard':
                    if (roll < 0.10) return 5;  
                    if (roll < 0.40) return 10; 
                    return 15; 
                default:
                    return 5; 
            }
        }

        
        const GAME_WIDTH = 400;
        const GAME_HEIGHT = 300;
        canvas.width = GAME_WIDTH;
        canvas.height = GAME_HEIGHT;

        let gameState = 'LOADING';
        let fishLog = [];
        let lastCatch = "";
        let lastVoucherCode = ""; 

        let waitTimer = null, biteTimer = null, reelTimer = null, messageTimer = null;
        let reelProgress = 0, reelTarget = 100, reelPower = 10, reelTimeLimit = 3000;

        const difficultySettings = {
            easy: { name:"Easy", biteWindow:2000, reelTargetBase:50, reelTimeBase:4000, button:{ x:350, y:40, w:70, h:20 }},
            medium: { name:"Medium", biteWindow:1500, reelTargetBase:80, reelTimeBase:2500, button:{ x:350, y:65, w:70, h:20 }},
            hard: { name:"Hard", biteWindow:1000, reelTargetBase:100, reelTimeBase:2000, button:{ x:350, y:90, w:70, h:20 }}
        };
        let currentDifficulty = null;

        const images = {
            player: new Image(),
            background: new Image(),
            fishIcon: new Image()
        };

        const assetSources = {
            player: 'image/personGames.png',
            background: 'image/backgroundGames.jpg',
            fishIcon: 'https://placehold.co/32x32/AAAAAA/000?text=Fish'
        };

        let assetsLoaded = 0, totalAssets = Object.keys(images).length;
        function assetLoaded(){ assetsLoaded++; if(assetsLoaded===totalAssets) gameState='MENU'; }
        for(const k in images){ images[k].src = assetSources[k]; images[k].onload = assetLoaded; images[k].onerror = assetLoaded; }

        let bobberY = GAME_HEIGHT * 0.6, bobberDirection = 1, fishShadows = [];
        const fishTypes = [
            { name:"Old Boot", rarity:0.30, color:"#8B4513" },
            { name:"Seaweed", rarity:0.20, color:"#228B22" },
            { name:"Minnow", rarity:0.20, color:"#AAAAAA" },
            { name:"Trout", rarity:0.15, color:"#b5651d" },
            { name:"Salmon", rarity:0.10, color:"#FA8072" },
            { name:"Giant Sturgeon", rarity:0.05, color:"#4A4A4A" }
        ];
        let lastFishColor="#fff";

        
        
        function castLine(){
            clearAllTimers();
            gameState='WAITING';
            bobberY = GAME_HEIGHT * 0.45;
            waitTimer = setTimeout(getBite, Math.random()*5000+2000);
        }
        function getBite(){ gameState='BITE'; biteTimer=setTimeout(()=>missedFish("Too slow!"),currentDifficulty.biteWindow); }
        function startReeling(){
            clearAllTimers();
            gameState='REELING'; reelProgress=0;
            const fish = getRandomFish(); 
            lastCatch = fish.name; 
            lastFishColor = fish.color;
            reelTarget = currentDifficulty.reelTargetBase + (1 - fish.rarity)*100;
            reelTimeLimit = currentDifficulty.reelTimeBase + (1 - fish.rarity)*1500;
            reelTimer = setTimeout(()=>missedFish("It got away!"), reelTimeLimit);
        }
        function reelIn(){ if(gameState==='REELING'){ reelProgress+=reelPower; if(reelProgress>=reelTarget){ clearAllTimers(); showCatch(); }}}
        
        
        function showCatch(){ 
            gameState='CAUGHT'; 
            
            
            const discountWon = calculateDiscountVoucher(currentDifficulty.name);
            lastVoucherCode = `FISH-${Date.now().toString().slice(-6)}`; 
            const newVoucher = { 
                percent: discountWon, 
                code: lastVoucherCode, 
                used: false,
                dateWon: new Date().toISOString() 
            };
            
            
            if (!currentUserData.discountVouchers) {
                currentUserData.discountVouchers = []; 
            }
            currentUserData.discountVouchers.push(newVoucher);
            updateCurrentUserData(currentUserData);
            
            
            lastCatch = `${discountWon}% Voucher!`; 
            
            fishLog.push(lastCatch); 
            messageTimer=setTimeout(()=>gameState='MENU', 4000); 
        }

        
        function missedFish(msg){ 
            clearAllTimers(); 
            gameState='MISSED'; 
            lastCatch=msg; 
            messageTimer=setTimeout(()=>gameState='MENU', 3000); 
        }

        function clearAllTimers(){ clearTimeout(waitTimer); clearTimeout(biteTimer); clearTimeout(reelTimer); clearTimeout(messageTimer);}
        function getRandomFish(){ let r=Math.random(),c=0; for(const f of fishTypes){c+=f.rarity;if(r<=c)return f;}return fishTypes[0];}

        canvas.addEventListener('click', e=>{
            switch(gameState){
                case 'MENU': handleMenuClick(e); break;
                case 'BITE': startReeling(); break;
                case 'REELING': reelIn(); break;
            }
        });

        
        function handleMenuClick(event){
            
            if (!currentUserData || currentUserData.gameVouchers <= 0) {
                
                return;
            }

            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;   
            const scaleY = canvas.height / rect.height;  
            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;
            
            for(const set of Object.values(difficultySettings)){
                const b=set.button;
                if(x>b.x-b.w/2 && x<b.x+b.w/2 && y>b.y-b.h/2 && y<b.y+b.h/2){
                    
                   
                    currentUserData.gameVouchers -= 1; 
                    updateCurrentUserData(currentUserData); 
                    voucherCountEl.textContent = `Game Vouchers: ${currentUserData.gameVouchers}`; 
                    
                    
                    currentDifficulty=set; 
                    castLine(); 
                    return; 
                }
            }
        }

        

        function drawPlayer(){
            const px = GAME_WIDTH*0.28, py = GAME_HEIGHT*0.53+10;
            ctx.drawImage(images.player, px-images.player.width/2, py-images.player.height);
        }

        function drawFishingRod(){
            const rodBaseX = GAME_WIDTH * 0.28;
            const rodBaseY = GAME_HEIGHT * 0.47;
            const bobberX = GAME_WIDTH * 0.7;
            const waterLevel = GAME_HEIGHT * 0.6;
            let targetY = waterLevel;

            if(gameState==="WAITING"){
                targetY += bobberDirection*0.1;
                if(bobberY>waterLevel+3||bobberY<waterLevel-3) bobberDirection*=-1;
            } else if(gameState==="BITE"){
                targetY += bobberDirection*1;
                if(bobberY>waterLevel+4||bobberY<waterLevel-4) bobberDirection*=-1;
            }
            bobberY = targetY;

            const dx=bobberX-rodBaseX, dy=bobberY-rodBaseY;
            const dist=Math.sqrt(dx*dx+dy*dy);
            const rodLen=55;
            const tipX=rodBaseX+(dx/dist)*rodLen;
            const tipY=rodBaseY+(dy/dist)*rodLen;

            ctx.strokeStyle="#8B4513"; ctx.lineWidth=3;
            ctx.beginPath(); ctx.moveTo(rodBaseX,rodBaseY); ctx.lineTo(tipX,tipY); ctx.stroke();
            return { x:tipX, y:tipY, bobberX, bobberY };
        }

        function drawFishingLine(rodTip){
            ctx.strokeStyle="#FFFFFF"; ctx.lineWidth=1;
            ctx.beginPath(); ctx.moveTo(rodTip.x,rodTip.y); ctx.lineTo(rodTip.bobberX,rodTip.bobberY); ctx.stroke();
            ctx.fillStyle="#FF0000"; ctx.fillRect(rodTip.bobberX-3,rodTip.bobberY-3,6,3);
            ctx.fillStyle="#FFFFFF"; ctx.fillRect(rodTip.bobberX-3,rodTip.bobberY,6,3);
        }

        function createFishShadow(){ if(Math.random()<0.01&&fishShadows.length<5) fishShadows.push({x:GAME_WIDTH+20,y:GAME_HEIGHT*0.65+Math.random()*80,speed:0.5+Math.random()*0.5});}
        function updateShadows(){
            createFishShadow();
            ctx.fillStyle="rgba(0,0,0,0.3)";
            for(let i=fishShadows.length-1;i>=0;i--){
                let f=fishShadows[i]; f.x-=f.speed;
                ctx.beginPath(); ctx.ellipse(f.x,f.y,10,4,0,0,2*Math.PI); ctx.fill();
                if(f.x<-20) fishShadows.splice(i,1);
            }
        }

        function drawLoading(){
            ctx.fillStyle="#000"; ctx.fillRect(0,0,GAME_WIDTH,GAME_HEIGHT);
            ctx.textAlign="center"; ctx.font="16px Courier";
            drawText(`Loading assets... ${assetsLoaded}/${totalAssets}`, GAME_WIDTH/2, GAME_HEIGHT/2);
        }

        
        function drawMenu(){
            ctx.font="bold 14px Courier"; drawText("Difficulty",350,20);
            ctx.font="12px Courier";
            
            
            const hasVouchers = currentUserData && currentUserData.gameVouchers > 0;
            
            for(const s of Object.values(difficultySettings)){
                const b=s.button; 
                ctx.fillStyle= hasVouchers ? "#444" : "#222"; 
                ctx.fillRect(b.x-b.w/2,b.y-b.h/2,b.w,b.h);
                ctx.fillStyle= hasVouchers ? "#FFF" : "#666"; 
                ctx.fillText(s.name,b.x,b.y+4);
            }
            
            if (!hasVouchers) {
                ctx.font="14px Courier";
                ctx.fillStyle="#FF0000";
                drawText("No Game Vouchers!", 325, 120);
            }
        }

        function drawText(t,x,y){
            ctx.fillStyle="#000"; ctx.fillText(t,x-1,y-1); ctx.fillText(t,x+1,y-1);
            ctx.fillText(t,x-1,y+1); ctx.fillText(t,x+1,y+1);
            ctx.fillStyle="#FFF"; ctx.fillText(t,x,y);
        }

        function drawPixelFish(x,y){
            ctx.drawImage(images.fishIcon,x-images.fishIcon.width/2,y-images.fishIcon.height/2);
        }

        function drawFishLog(){
            ctx.textAlign="left"; ctx.fillStyle="rgba(0,0,0,0.5)"; ctx.fillRect(5,5,120,100);
            ctx.fillStyle="#FFF"; ctx.font="12px Courier"; ctx.fillText("Catch Log:",10,20);
            let y=35, list=fishLog.slice(-5).reverse();
            if(list.length===0){ ctx.fillStyle="#AAA"; ctx.font="10px Courier"; ctx.fillText("Empty",10,40); }
            else{
                for(let f of list){ ctx.fillStyle="#FFF"; ctx.fillText(`- ${f.substring(0, 12)}...`,10,y); y+=12; }
            }
            ctx.textAlign="center";
        }

        
        function draw(){
            ctx.drawImage(images.background,0,0,GAME_WIDTH,GAME_HEIGHT);
            drawPlayer();
            const tip = drawFishingRod();
            updateShadows();

            ctx.font="16px Courier"; ctx.fillStyle="#FFF"; ctx.textAlign="center";

            switch(gameState){
                case 'LOADING': drawLoading(); break;
                case 'MENU': drawMenu(); break;
                case 'WAITING': drawFishingLine(tip); drawText("Waiting...",GAME_WIDTH/2,GAME_HEIGHT/3); break;
                case 'BITE':
                    drawFishingLine(tip);
                    ctx.font="bold 30px Courier"; ctx.fillStyle="#FF0000";
                    drawText("!",tip.x+10,tip.y-20);
                    ctx.font="bold 24px Courier"; drawText("BITE!",GAME_WIDTH/2,GAME_HEIGHT/3);
                    break;
                case 'REELING':
                    drawText("CLICK!",GAME_WIDTH/2,GAME_HEIGHT/3);
                    ctx.fillStyle="#444"; ctx.fillRect(GAME_WIDTH*0.2,GAME_HEIGHT*0.5-15,GAME_WIDTH*0.6,30);
                    ctx.fillStyle="#0F0"; ctx.fillRect(GAME_WIDTH*0.2,GAME_HEIGHT*0.5-15,(reelProgress/reelTarget)*(GAME_WIDTH*0.6),30);
                    break;
                case 'CAUGHT': 
                    
                    drawText(lastCatch, GAME_WIDTH/2, GAME_HEIGHT/3); 
                    
                    ctx.font="14px Courier";
                    drawText(`Code: ${lastVoucherCode}`, GAME_WIDTH/2, GAME_HEIGHT/3 + 30);
                    drawPixelFish(GAME_WIDTH/2, GAME_HEIGHT/2 + 20); 
                    break;
                case 'MISSED': drawText(lastCatch,GAME_WIDTH/2,GAME_HEIGHT/3); break;
            }
            drawFishLog();
        }

        function gameLoop(){ ctx.clearRect(0,0,GAME_WIDTH,GAME_HEIGHT); draw(); requestAnimationFrame(gameLoop); }
        
        
        function updateCartCount() {
            const cartKey = 'fs_cart';
            const cart = JSON.parse(localStorage.getItem(cartKey)) || [];
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            const countEl = document.getElementById('cart-count');
            if (countEl) {
                countEl.textContent = count > 0 ? count : '';
            }
        }
        function setupHeader() {
            const utilityLinks = document.getElementById('header-utility-links');
            
            if (loggedInUser) {
                utilityLinks.innerHTML = `
                    <a href="accountMain.html" style="font-weight: bold;">${loggedInUser.username}</a>
                    <span class="slash">/</span>
                    <a href="#" id="header-logout-link">Log Out</a>
                `;
                const headerLogout = document.getElementById('header-logout-link');
                if (headerLogout) {
                    headerLogout.addEventListener('click', function(event) {
                        event.preventDefault();
                        sessionStorage.removeItem('loggedInUser');
                        alert('You have been logged out.');
                        window.location.href = 'accountPage.html';
                    });
                }
            } else {
                utilityLinks.innerHTML = '<a href="accountPage.html">Account</a>';
            }
            updateCartCount();
        }
        
        
        setupHeader();
        
        
        currentUserData = getCurrentUserData();
        if (currentUserData) {
            
            if (typeof currentUserData.gameVouchers === 'undefined') {
                currentUserData.gameVouchers = 0;
            }
            if (!Array.isArray(currentUserData.discountVouchers)) {
                currentUserData.discountVouchers = [];
            }
            
            voucherCountEl.textContent = `Game Vouchers: ${currentUserData.gameVouchers}`;
            updateCurrentUserData(currentUserData); 
        } else {
            
            voucherCountEl.textContent = "Error loading user data.";
        }
        
        gameLoop(); 
    });
    </script>
</body>
</html>