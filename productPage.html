<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product - FS Fashion Marketplace</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
   
</head>
<body class="brands-page">
    <header class="header">
        <div class="header-container">
            <div class="logo">
                <a href="index.html" class="logo-link">
                    <span class="logo-text">FS</span>
                </a>
            </div>
            <nav class="navigation">
                <ul class="nav-links">
                    <li><a href="categoryPage.html">Shop</a></li>
                    <li><a href="brandsPage.html">Brands</a></li>
                    <li><a href="searchPage.html">Search</a></li>
                    <li><a href="inspirationPage.html">Inspiration</a></li>
                    <li><a href="games.html">Games</a></li>
                </ul>
            </nav>
            <div class="right-actions">
               
                <a href="bagPage.html" class="bag-link">Bag <span id="cart-count"></span></a>
                <div class="utility-links" id="header-utility-links">
                   
                    <a href="accountPage.html">Account</a>
                </div>
            </div>
        </div>
    </header>

    
    <section class="product-detail-page">
        <a href="javascript:history.back()" class="back-link">← Back to Products</a>
        
        <div class="product-detail-container">
            <div class="product-image-container">
                <div class="slider" id="imageSlider">
                    <div class="slider-viewport">
                        <div class="slides" id="sliderSlides"></div>
                    </div>
                    <button class="slider-btn prev" id="sliderPrev" aria-label="Previous image">‹</button>
                    <button class="slider-btn next" id="sliderNext" aria-label="Next image">›</button>
                </div>
            </div>
            
            <div class="product-info-container">
                <h1 id="productName" class="product-detail-name">Product Name</h1>
                <p id="productPrice" class="product-detail-price">$0.00</p>
                <p id="productDescription" class="product-detail-description">
                    Product description goes here. This is where detailed information about the product will be displayed.
                </p>
                
                
                <div class="size-selector" id="size-selector-container">
                    <label class="size-selector-label">Size</label>
                    <div class="size-options" id="size-options">
                        
                    </div>
                    <p class="size-error" id="size-error">Please select a size.</p>
                </div>
                
                <div class="product-detail-actions">
                    <button class="add-to-cart-btn" id="add-to-cart-btn">Add to Cart</button>
                    <button class="wishlist-btn" id="wishlist-btn">♡ Wishlist</button>
                </div>
                
                <div class="product-detail-specs">
                    <div class="spec-item">
                        <span class="spec-label">Brand:</span>
                        <span id="productBrand" class="spec-value">Unknown</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">Material:</span>
                        <span id="productMaterial" class="spec-value">Cotton</span>
                    </div>
                    <div class="spec-item">
                        <span class="spec-label">Size:</span>
                        <span id="productSize" class="spec-value">One Size</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-column">
                <h3>Brands</h3>
                <ul>
                    <li><a href="brandPage.html?brand=Rick%20Owens">Rick Owens</a></li>
                    <li><a href="brandPage.html?brand=Maison%20Margiela">Maison Margiela</a></li>
                    <li><a href="brandPage.html?brand=Balenciaga">Balenciaga</a></li>
                    <li><a href="brandPage.html?brand=Vivienne%20Westwood">Vivienne Westwood</a></li>
                    <li><a href="brandsPage.html">Other Brands</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h3>Category</h3>
                <ul>
                    <li><a href="categoryPage.html?category=tops">Tops</a></li>
                    <li><a href="categoryPage.html?category=outerwear">Outerwear</a></li>
                    <li><a href="categoryPage.html?category=bottoms">Bottoms</a></li>
                    <li><a href="categoryPage.html?category=accessories">Accessories</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <script src="products.js"></script>
    <script>
        
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');
        const usersStorageKey = 'fs_users';
        const cartKey = 'fs_cart';
        const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
        let selectedSize = null;
        let currentProduct = null;

        
        function updateCartCount() {
            const cart = JSON.parse(localStorage.getItem(cartKey)) || [];
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            const countEl = document.getElementById('cart-count');
            if (countEl) {
                countEl.textContent = count > 0 ? count : '';
            }
        }

       
        function setupHeader() {
            const utilityLinks = document.getElementById('header-utility-links');
            if (user) {
                utilityLinks.innerHTML = `
                    <a href="accountMain.html" style="font-weight: bold;">${user.username}</a>
                    <span class="slash">/</span>
                    <a href="#" id="header-logout-link">Log Out</a>
                `;
                const headerLogout = document.getElementById('header-logout-link');
                if (headerLogout) {
                    headerLogout.addEventListener('click', function(event) {
                        event.preventDefault();
                        sessionStorage.removeItem('loggedInUser');
                        alert('You have been logged out.');
                        window.location.href = 'accountPage.html';
                    });
                }
            } else {
                utilityLinks.innerHTML = '<a href="accountPage.html">Account</a>';
            }
            updateCartCount(); 
        }

        
        function renderNotFound() {
            document.getElementById('productName').textContent = 'Product Not Found';
            document.getElementById('productPrice').textContent = '';
            document.getElementById('productDescription').textContent = 'The requested product could not be found.';
            document.getElementById('productBrand').textContent = '-';
            document.getElementById('productMaterial').textContent = '-';
            document.getElementById('productSize').textContent = '-';
            document.title = 'Product Not Found - FS Fashion Marketplace';
            document.querySelector('.add-to-cart-btn').disabled = true;
        }
        
        
        function generateSizeOptions(product) {
            const sizeString = product.size || "One Size";
            const sizeContainer = document.getElementById('size-options');
            let options = [];

            
            if (sizeString.match(/^EU \d+-\d+$/)) { 
                const range = sizeString.split(' ')[1]; 
                const [start, end] = range.split('-').map(Number);
                for (let i = start; i <= end; i++) {
                    options.push(i.toString());
                }
            } else if (sizeString.match(/^[A-Z]+-[A-Z]+$/)) { 
                const sizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL']; 
                const [startSize, endSize] = sizeString.split('-');
                const startIndex = sizes.indexOf(startSize);
                const endIndex = sizes.indexOf(endSize);
                
                if (startIndex !== -1 && endIndex !== -1) {
                    options = sizes.slice(startIndex, endIndex + 1);
                } else {
                    options = [sizeString]; 
                }
            } else { 
                options = [sizeString]; 
            }
            
            
            if (options.length === 0) {
                 document.getElementById('size-selector-container').style.display = 'none';
                 return;
            }
            
            sizeContainer.innerHTML = options.map(size => 
                `<button class="size-btn" data-size="${size}">${size}</button>`
            ).join('');
            
            
            sizeContainer.querySelectorAll('.size-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    sizeContainer.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedSize = btn.dataset.size;
                    document.getElementById('size-error').style.display = 'none';
                });
            });
            
            
            if (options.length === 1) {
                 sizeContainer.querySelector('.size-btn').classList.add('selected');
                 selectedSize = options[0];
            }
        }

        function loadProductDetail() {
            if (!window.PRODUCTS || !Array.isArray(window.PRODUCTS)) {
                renderNotFound();
                return;
            }

            currentProduct = window.PRODUCTS.find(p => p.id === productId);
            if (!currentProduct) {
                renderNotFound();
                return;
            }

            document.getElementById('productName').textContent = currentProduct.name;
            document.getElementById('productPrice').textContent = currentProduct.price;
            document.getElementById('productDescription').textContent = currentProduct.description;
            document.getElementById('productBrand').textContent = currentProduct.brand;
            document.getElementById('productMaterial').textContent = currentProduct.material;
            
            
            document.getElementById('productSize').textContent = currentProduct.size; 
            
            
            generateSizeOptions(currentProduct); 
            
            
            const images = Array.isArray(currentProduct.images) && currentProduct.images.length > 0
                ? currentProduct.images
                : [currentProduct.image || 'image/mainImage.jpeg'];

            const slidesEl = document.getElementById('sliderSlides');
            slidesEl.innerHTML = images.map((src, idx) => {
                const altText = `${currentProduct.name} ${idx + 1}`;
                const fallbackSrc = currentProduct.image || 'image/mainImage.jpeg';
                const onErrorScript = `if (this.src.endsWith('${fallbackSrc}')) return; this.src = '${fallbackSrc}'`;
                
                return `
                    <div class="slide">
                        <img src="${src}" alt="${altText}" class="product-detail-image" onerror="${onErrorScript}">
                    </div>
                `;
            }).join('');

            let currentSlide = 0;
            const slideElements = slidesEl.querySelectorAll('.slide');
            const totalSlides = slideElements.length;

            function updateSlider() {
                const offsetPercent = -(currentSlide * 100);
                slidesEl.style.transform = `translateX(${offsetPercent}%)`;
                document.getElementById('sliderPrev').style.display = totalSlides > 1 ? 'flex' : 'none';
                document.getElementById('sliderNext').style.display = totalSlides > 1 ? 'flex' : 'none';
            }

            function goToSlide(index) {
                currentSlide = (index + totalSlides) % totalSlides;
                updateSlider();
            }

            document.getElementById('sliderPrev').addEventListener('click', () => goToSlide(currentSlide - 1));
            document.getElementById('sliderNext').addEventListener('click', () => goToSlide(currentSlide + 1));

            slidesEl.style.display = 'flex';
            slidesEl.style.transition = 'transform 300ms ease';
            slideElements.forEach(slide => {
                slide.style.minWidth = '100%';
            });
            updateSlider();
            

            document.title = currentProduct.name + ' - FS Fashion Marketplace';

            
            document.getElementById('add-to-cart-btn').addEventListener('click', function() {
                
                if (!selectedSize) {
                    document.getElementById('size-error').style.display = 'block';
                    return;
                }
                
                
                let cart = JSON.parse(localStorage.getItem(cartKey)) || [];
                
                
                const uniqueItemId = `${currentProduct.id}_${selectedSize}`;
                
                
                const existingItemIndex = cart.findIndex(item => item.uniqueId === uniqueItemId);
                
                if (existingItemIndex > -1) {
                    
                    cart[existingItemIndex].quantity += 1;
                } else {
                    
                    cart.push({
                        id: currentProduct.id,
                        uniqueId: uniqueItemId,
                        name: currentProduct.name,
                        price: currentProduct.price,
                        image: currentProduct.image,
                        size: selectedSize,
                        quantity: 1
                    });
                }
                
                
                localStorage.setItem(cartKey, JSON.stringify(cart));
                
                
                alert('Added to Bag: ' + currentProduct.name + ' (Size: ' + selectedSize + ')');
                
                
                updateCartCount();
            });

            
            const wishlistBtn = document.getElementById('wishlist-btn');
            
            function getWishlist() {
                if (!user) return null;
                const allUsers = JSON.parse(localStorage.getItem(usersStorageKey)) || [];
                const currentUserData = allUsers.find(u => u.email === user.email);
                return currentUserData ? currentUserData.wishlist : null;
            }

            function saveWishlist(wishlist) {
                if (!user) return;
                let allUsers = JSON.parse(localStorage.getItem(usersStorageKey)) || [];
                let userIndex = allUsers.findIndex(u => u.email === user.email);
                if (userIndex !== -1) {
                    allUsers[userIndex].wishlist = wishlist;
                    localStorage.setItem(usersStorageKey, JSON.stringify(allUsers));
                }
            }
            
            function updateWishlistButton() {
                const wishlist = getWishlist();
                if (wishlist && wishlist.includes(productId)) {
                    wishlistBtn.textContent = '❤️ Added to Wishlist';
                    wishlistBtn.classList.add('active');
                } else {
                    wishlistBtn.textContent = '♡ Wishlist';
                    wishlistBtn.classList.remove('active');
                }
            }

            updateWishlistButton();

            wishlistBtn.addEventListener('click', function() {
                if (!user) {
                    alert('Please sign in to add items to your wishlist.');
                    window.location.href = `accountPage.html?redirect=productPage.html?id=${productId}`;
                    return;
                }
                
                let wishlist = getWishlist();
                if (wishlist === null) return; 

                if (wishlist.includes(productId)) {
                    wishlist = wishlist.filter(id => id !== productId);
                } else {
                    wishlist.push(productId);
                }
                
                saveWishlist(wishlist);
                updateWishlistButton();
            });
            
        }

        setupHeader();
        loadProductDetail();
    </script>
</body>
</html>
